{"version":3,"sources":["../../../../node_modules/next/src/build/webpack/loaders/next-flight-loader/server-reference.ts","../../../../node_modules/next/src/build/webpack/loaders/next-flight-loader/action-validate.ts","../../../../src/modules/pos/api/redemption.api.ts","../../../../src/modules/pos/actions/validate-redemption.action.ts","../../../../.next-internal/server/app/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["/* eslint-disable import/no-extraneous-dependencies */\nexport { registerServerReference } from 'react-server-dom-webpack/server'\n","// This function ensures that all the exported values are valid server actions,\n// during the runtime. By definition all actions are required to be async\n// functions, but here we can only check that they are functions.\nexport function ensureServerEntryExports(actions: any[]) {\n  for (let i = 0; i < actions.length; i++) {\n    const action = actions[i]\n    if (typeof action !== 'function') {\n      throw new Error(\n        `A \"use server\" file can only export async functions, found ${typeof action}.\\nRead more: https://nextjs.org/docs/messages/invalid-use-server-value`\n      )\n    }\n  }\n}\n","\"use server\";\nimport { createClient } from \"@/lib/supabase/server\";\nexport interface RedemptionValidationResult {\n  success: boolean;\n  redemption?: {\n    id: string;\n    user_id: string;\n    reward_id: string;\n    reward_name: string;\n    points_spent: number;\n    status: string;\n    created_at: string;\n  };\n  error?: string;\n}\nexport async function validateRedemption(\n  qrCode: string\n): Promise<RedemptionValidationResult> {\n  try {\n    const supabase = await createClient();\n    const cleanQrCode = qrCode.trim();\n    const { data: redemption, error: redemptionError } = await supabase\n      .from(\"loyalty_redemptions\")\n      .select(\n        `\n        id,\n        user_id,\n        reward_id,\n        points_spent,\n        status,\n        created_at,\n        loyalty_rewards (\n          name\n        )\n      `\n      )\n      .eq(\"qr_code\", cleanQrCode)\n      .single();\n    if (redemptionError || !redemption) {\n      return {\n        success: false,\n        error: redemptionError?.message || \"Codigo QR no encontrado\",\n      };\n    }\n    if (redemption.status !== \"pending\") {\n      return {\n        success: false,\n        error:\n          redemption.status === \"validated\"\n            ? \"Este codigo ya fue utilizado\"\n            : redemption.status === \"cancelled\"\n              ? \"Este codigo ha sido cancelado\"\n              : \"Este codigo no esta disponible\",\n      };\n    }\n    return {\n      success: true,\n      redemption: {\n        id: redemption.id,\n        user_id: redemption.user_id,\n        reward_id: redemption.reward_id,\n        reward_name: (redemption.loyalty_rewards as any)?.name || \"Producto\",\n        points_spent: redemption.points_spent,\n        status: redemption.status,\n        created_at: redemption.created_at,\n      },\n    };\n  } catch (error) {\n    console.error(\"Error validando redencion:\", error);\n    return {\n      success: false,\n      error: \"Error inesperado al validar el codigo\",\n    };\n  }\n}\nexport async function markRedemptionAsUsed(\n  redemptionId: string,\n  orderId?: string\n): Promise<{ success: boolean; error?: string }> {\n  try {\n    const supabase = await createClient();\n    const {\n      data: { user },\n      error: userError,\n    } = await supabase.auth.getUser();\n    if (userError || !user) {\n      return { success: false, error: \"No se pudo autenticar\" };\n    }\n    const { error: updateError } = await supabase\n      .from(\"loyalty_redemptions\")\n      .update({\n        status: \"validated\",\n        validated_at: new Date().toISOString(),\n        order_id: orderId || null,\n      })\n      .eq(\"id\", redemptionId);\n    if (updateError) {\n      return { success: false, error: \"Error al procesar la redencion\" };\n    }\n    return { success: true };\n  } catch (error) {\n    console.error(\"Error inesperado:\", error);\n    return { success: false, error: \"Error inesperado\" };\n  }\n}\r\n\r\n","\"use server\";\nimport { validateRedemption, markRedemptionAsUsed } from \"../api/redemption.api\";\nimport type { RedemptionValidationResult } from \"../api/redemption.api\";\nexport interface ProcessRedemptionResult {\n  success: boolean;\n  redemption?: RedemptionValidationResult[\"redemption\"];\n  error?: string;\n}\nexport async function processRedemptionAction(\n  qrCode: string,\n  orderId?: string\n): Promise<ProcessRedemptionResult> {\n  try {\n    const validation = await validateRedemption(qrCode);\n    if (!validation.success || !validation.redemption) {\n      return {\n        success: false,\n        error: validation.error || \"Codigo QR invalido\",\n      };\n    }\n    const markResult = await markRedemptionAsUsed(validation.redemption.id, orderId);\n    if (!markResult.success) {\n      return {\n        success: false,\n        error: markResult.error || \"Error al procesar la redencion\",\n      };\n    }\n    return {\n      success: true,\n      redemption: validation.redemption,\n    };\n  } catch (error) {\n    console.error(\"Error procesando redencion:\", error);\n    return {\n      success: false,\n      error: \"Error inesperado al procesar la redencion\",\n    };\n  }\n}\r\n","export {validateRedemption as '408093cec055993d27ccf31b16553a83b925d68f64'} from 'ACTIONS_MODULE0'\nexport {processRedemptionAction as '606344c6f1116c1de062d21a4b4bdf4d2412f5c316'} from 'ACTIONS_MODULE1'\n"],"names":["registerServerReference","ensureServerEntryExports","actions","i","length","action","Error"],"mappings":"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","ignoreList":[0,1]}